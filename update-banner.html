<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pinokio Update</title>
    <style>
      :root {
        --bg: rgba(24, 24, 30, 0.94);
        --bg-strong: rgba(30, 30, 38, 0.98);
        --border: rgba(255, 255, 255, 0.12);
        --text: #f5f5f7;
        --muted: rgba(255, 255, 255, 0.68);
        --accent: #f6c251;
        --accent-strong: #ffcc66;
        --danger: #ff7b72;
        --shadow: 0 12px 26px rgba(0, 0, 0, 0.35);
      }

      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background: transparent;
        font-family: "SF Pro Text", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }

      #banner {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 10px 16px 12px;
        background: linear-gradient(90deg, var(--bg), var(--bg-strong));
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow);
        border-radius: 0;
      }

      .left {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      #title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text);
        letter-spacing: 0.1px;
      }

      #details {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 520px;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      button {
        appearance: none;
        border: 1px solid transparent;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease, transform 120ms ease;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .primary {
        color: #1b1b1f;
        background: var(--accent);
      }

      .primary:hover:not(:disabled) {
        background: var(--accent-strong);
        transform: translateY(-1px);
      }

      .ghost {
        color: var(--text);
        background: transparent;
        border-color: rgba(255, 255, 255, 0.18);
      }

      .ghost:hover:not(:disabled) {
        border-color: rgba(255, 255, 255, 0.35);
      }

      #progress {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 3px;
        background: rgba(255, 255, 255, 0.15);
      }

      #progress-bar {
        height: 100%;
        width: 0%;
        background: var(--accent);
        transition: width 150ms ease;
      }

      .hidden {
        display: none;
      }

      .danger {
        color: var(--danger);
      }
    </style>
  </head>
  <body>
    <div id="banner">
      <div class="left">
        <div id="title">Update available</div>
        <div id="details"></div>
      </div>
      <div class="actions">
        <button id="update-now" class="primary">Update now</button>
        <button id="restart-now" class="primary hidden">Restart now</button>
        <button id="view-release" class="ghost hidden">Release notes</button>
        <button id="dismiss" class="ghost">Later</button>
      </div>
      <div id="progress" class="hidden">
        <div id="progress-bar"></div>
      </div>
    </div>
    <script>
      const { ipcRenderer } = require('electron');

      const title = document.getElementById('title');
      const details = document.getElementById('details');
      const updateNow = document.getElementById('update-now');
      const restartNow = document.getElementById('restart-now');
      const dismiss = document.getElementById('dismiss');
      const viewRelease = document.getElementById('view-release');
      const progress = document.getElementById('progress');
      const progressBar = document.getElementById('progress-bar');

      let lastPayload = {};

      const setHidden = (el, hidden) => {
        if (!el) return;
        el.classList.toggle('hidden', Boolean(hidden));
      };

      const setText = (el, text) => {
        if (!el) return;
        el.textContent = text || '';
      };

      const render = (payload = {}) => {
        lastPayload = payload || {};
        const state = payload.state || 'available';
        const version = payload.version ? `Version ${payload.version}` : '';
        const notes = payload.notesPreview || '';
        const detail = [version, notes].filter(Boolean).join(' - ');

        let titleText = 'Update available';
        if (state === 'downloading') titleText = 'Downloading update';
        if (state === 'ready') titleText = 'Update ready';
        if (state === 'error') titleText = 'Update failed';

        setText(title, titleText);
        setText(details, detail);

        const isDownloading = state === 'downloading';
        const isReady = state === 'ready';
        const isError = state === 'error';
        const hasReleaseUrl = Boolean(payload.releaseUrl);

        updateNow.textContent = isError ? 'Retry' : 'Update now';
        updateNow.disabled = isDownloading;

        setHidden(updateNow, isReady);
        setHidden(restartNow, !isReady);
        setHidden(viewRelease, !hasReleaseUrl);
        setHidden(progress, !isDownloading);

        if (isError) {
          title.classList.add('danger');
        } else {
          title.classList.remove('danger');
        }

        if (isDownloading && typeof payload.progressPercent === 'number') {
          const percent = Math.max(0, Math.min(100, payload.progressPercent));
          progressBar.style.width = `${percent}%`;
        } else {
          progressBar.style.width = '0%';
        }
      };

      ipcRenderer.on('pinokio:update-banner', (_event, payload) => {
        render(payload);
      });

      updateNow.addEventListener('click', () => {
        ipcRenderer.send('pinokio:update-banner-action', { action: 'update' });
      });

      restartNow.addEventListener('click', () => {
        ipcRenderer.send('pinokio:update-banner-action', { action: 'restart' });
      });

      dismiss.addEventListener('click', () => {
        ipcRenderer.send('pinokio:update-banner-action', { action: 'dismiss' });
      });

      viewRelease.addEventListener('click', () => {
        if (lastPayload.releaseUrl) {
          ipcRenderer.send('pinokio:update-banner-action', {
            action: 'release-notes',
            releaseUrl: lastPayload.releaseUrl
          });
        }
      });
    </script>
  </body>
</html>
